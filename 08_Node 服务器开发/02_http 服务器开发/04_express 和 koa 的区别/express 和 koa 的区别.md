## 一、设计哲学

express 的设计哲学是“约定大于配置”，比方说 express 内置了很多开发中我们会用到的中间件，比如路由、json 请求体解析和表单请求体解析、上传文件、静态资源部署等，所以 express 是一个非常完整的框架

koa 的设计哲学是“让复杂的事情简单化”，它就仅仅是实现了 http 服务器开发的核心功能，没有内置任何中间件，开发中我们需要手动安装很多中间件，所以 koa 是一个极简的框架。现在很多 web 框架的趋势就是一个框架只负责一件事，所以 koa 框架是顺应了这一趋势

## 二、中间件执行机制

express 和 koa 的核心都是中间件，但是它们在中间件的执行机制上稍有不同

`当执行同步中间件的时候，express 和 koa 其实没区别，中间件的执行流程都符合洋葱圈模型`

`当执行异步中间件的时候，express 只能是流水线模型，而 koa 的 next() 函数如果用了 await 那就符合洋葱圈模型、如果不用那就符合流水线模型、洋葱圈模型在处理异步时更优雅`

所谓洋葱圈模型其实就类似于函数嵌套调用时，函数栈内存的分配与释放，从外层函数向内层函数依次分配栈内存，然后从内层函数向外层函数依次释放栈内存。中间件也是一样的道理，从外层中间件向内层中间件依次调用，然后从内层中间件向外层中间件依次拿到结果

而流水线模型就是从上往下一个方向执行和拿结果，没法回头这样

那么实际开发中很多中间件都是异步中间件，使用 express 和 koa 执行异步中间件最大的区别就类似于使用回调函数和使用 async-await 来实现异步开发的情况，回调函数容易出现回调地狱、而 async-await 则很优雅。我们举个例子：中间件 1 是个统一对外暴露的接口 login，中间件 2 负责验证 token，中间件 3 负责验证用户名和密码，中间件 4 负责获取用户信息

* 使用 express 实现时，因为是流水线模型，所以一个中间件没法等待另一个中间件的执行结果，所以只能嵌套，然后在执行完最后一个中间时在最后一个中间件里返回本来是多个中间件共同决定的执行结果，容易出现嵌套地狱

```
let loginSuccess = false;

中间件 1 login() async {
  中间件 2(
    中间件 3(
      中间件 4(
        loginSuccess = true;
        return loginSuccess;
      );
    );
  );
}
```

* 使用 koa 实现时，更加优雅，可以等待多个中间件共同决定的执行结果最终返回

```
let loginSuccess = false;

中间件 1 login() async {
  await 中间件 2();
  await 中间件 3();
  await 中间件 4();

  loginSuccess = true;
  return loginSuccess;
}
```