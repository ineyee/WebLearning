// ç¬¬ä¸€æ­¥ï¼šå¯¼å…¥ http æ¨¡å—
const http = require("http");
// è§£æ url ç”¨çš„æ¨¡å—
const urlModule = require("url");
// è§£æ get è¯·æ±‚ url é‡Œå‚æ•°ç”¨çš„æ¨¡å—
const qsModule = require("querystring");

// ç¬¬äºŒæ­¥ï¼šåˆ›å»ºä¸€ä¸ª http æœåŠ¡å™¨å®ä¾‹
const httpServer = http.createServer();

// ç¬¬ä¸‰æ­¥ï¼šæŒ‡å®šè¦ç›‘å¬çš„ç«¯å£å¹¶å¯åŠ¨ http æœåŠ¡å™¨
// ç¬¬ä¸€ä¸ªå‚æ•°ï¼šè¦ç›‘å¬çš„ç«¯å£ï¼ˆå³æœåŠ¡è¦éƒ¨ç½²åœ¨å“ªä¸ªç«¯å£ä¸Šï¼‰
// ç¬¬äºŒä¸ªå‚æ•°ï¼šhttp æœåŠ¡å™¨å¯åŠ¨æˆåŠŸåçš„å›è°ƒå‡½æ•°
// 
// å› ä¸ºæˆ‘ä»¬ç¼–å†™çš„è¿™ä»½ä»£ç ï¼ˆå³æœåŠ¡ï¼‰ä¼šéƒ¨ç½²åœ¨æŸä¸ªç‰¹å®šçš„æœåŠ¡å™¨ä¸Šï¼ˆå³ä¸»æœºï¼‰ï¼Œå°†æ¥å®¢æˆ·ç«¯è®¿é—®æ—¶ä¼šé€šè¿‡ IP åœ°å€æˆ–åŸŸåæ¥æ‰¾åˆ°ç›¸åº”çš„æœåŠ¡å™¨ï¼Œæ‰€ä»¥æ˜¯ä¸éœ€è¦æŒ‡å®šä¸»æœºçš„ï¼Œåªéœ€è¦æŒ‡å®šç«¯å£å³å¯
httpServer.listen(8000, () => {
  console.log("ğŸš€æœåŠ¡å™¨å¯åŠ¨æˆåŠŸğŸš€");
});

// ç¬¬å››æ­¥ï¼šç›‘å¬æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚å¹¶è¿”å›å“åº”
// ç¬¬ä¸€ä¸ªå‚æ•°ï¼šè¯·æ±‚äº‹ä»¶ï¼ˆå³å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨æ—¶ä¼šè§¦å‘è¯¥äº‹ä»¶ï¼‰
// ç¬¬äºŒä¸ªå‚æ•°ï¼šå›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°ä¸­ä¼šä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯è¯·æ±‚å¯¹è±¡ï¼ˆreqï¼‰å’Œå“åº”å¯¹è±¡ï¼ˆresï¼‰
//    è¯·æ±‚å¯¹è±¡ï¼ˆrequestï¼‰ï¼šæœ¬è´¨å°±æ˜¯ä¸€ä¸ª ReadableStreamï¼Œç”¨æ¥è¯»å–å®¢æˆ·ç«¯å‘è¿‡æ¥çš„è¯·æ±‚æ•°æ®ã€‚åŒ…å«äº†å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨æ—¶çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¦‚è¯·æ±‚æ–¹æ³•ã€è¯·æ±‚è·¯å¾„ã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ç­‰
//    å“åº”å¯¹è±¡ï¼ˆresponseï¼‰ï¼šæœ¬è´¨å°±æ˜¯ä¸€ä¸ª WritableStreamï¼Œç”¨æ¥å†™å…¥å“åº”æ•°æ®ç»™å®¢æˆ·ç«¯ã€‚åŒ…å«äº†æœåŠ¡å™¨è¦è¿”å›ç»™å®¢æˆ·ç«¯çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¦‚å“åº”çŠ¶æ€ç ã€å“åº”å¤´ã€å“åº”ä½“ç­‰
httpServer.on("request", (req, res) => {
  const method = req.method;
  console.log("è¯·æ±‚æ–¹æ³•ï¼š", method);

  const urlString = req.url;
  const urlObj = urlModule.parse(urlString);
  const pathName = urlObj.pathname;
  console.log("è¯·æ±‚è·¯å¾„ï¼š", pathName);

  if (pathName === "/login") {
    if (method === "POST") {
      let jsonObj = {};

      // POST è¯·æ±‚ä¸€èˆ¬æœ‰è¯·æ±‚ä½“ï¼Œä¼ ç»™æœåŠ¡å™¨çš„ä¸€å †å…¥å‚ä¸€èˆ¬æ”¾åœ¨è¯·æ±‚ä½“é‡Œã€è€Œä¸æ˜¯ URL é‡Œ
      // æˆ‘ä»¬å‰é¢å·²ç»è¯´è¿‡ req å¯¹è±¡å…¶å®æ˜¯ä¸€ä¸ª ReadableStream å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›‘å¬ req å¯¹è±¡çš„ data äº‹ä»¶æ¥è·å–è¯·æ±‚ä½“é‡Œçš„æ•°æ®ã€‚ç›‘å¬æµçš„ data äº‹ä»¶ï¼Œæ¯å½“è¯»å–åˆ°æ•°æ®æ—¶ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶ï¼ˆæ­£æ˜¯å› ä¸º Stream ç±»ç»§æ‰¿è‡ª EventEmitter ç±»ï¼‰
      // é»˜è®¤ä¸€æ¬¡æ€§èƒ½è¯»å– 64KB çš„æ•°æ®ï¼Œä¸€èˆ¬çš„è¯·æ±‚èƒ½ä¸€æ¬¡æ€§è¯»å–å®Œï¼Œæ‰€ä»¥å°±ä¸ç”¨æ‹¼æ¥æ•°æ®äº†
      // å¹¶ä¸”è¿™é‡Œæ˜¯ä¸€ä¸ªå¸¸è§„çš„ç™»å½•è¯·æ±‚ï¼Œè€Œä¸æ˜¯å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ã€æ–‡ä»¶ç­‰é‚£ç±»éœ€è¦ç›´æ¥ç”¨äºŒè¿›åˆ¶æ•°æ®çš„è¯·æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠè¯»å–åˆ°çš„æ•°æ®ææˆ JSON å­—ç¬¦ä¸²è¾“å‡ºï¼ˆé»˜è®¤ç”¨çš„æ˜¯ utf-8 è§£ç ï¼‰ï¼Œå› ä¸ºå¸¸è§„è¯·æ±‚ä¸€èˆ¬ä¼ è¾“çš„éƒ½æ˜¯ JSON å­—ç¬¦ä¸²è€Œä¸æ˜¯ç›´æ¥çš„äºŒè¿›åˆ¶æ•°æ®
      req.on("data", (chunk) => {
        const jsonString = chunk.toString();
        jsonObj = JSON.parse(jsonString);
        console.log("è¯·æ±‚å‚æ•°ï¼š", jsonObj);
      });
      // ç›‘å¬æµçš„ end äº‹ä»¶ï¼Œå½“è¯»å–æ•°æ®å®Œæ¯•åï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
      req.on("end", () => {
        if (jsonObj.username === "watson" && jsonObj.password === "123456") {
          res.end(JSON.stringify({
            "code": 200,
            "message": "ç™»å½•æˆåŠŸ",
            "data": {
              "token": "1234567890",
            },
          }));
        } else {
          res.end(JSON.stringify({
            "code": 200,
            "message": "ç™»å½•å¤±è´¥",
            "data": {
              "msg": "è¯·æ£€æŸ¥ç”¨æˆ·åæˆ–å¯†ç æ˜¯å¦æ­£ç¡®",
            },
          }));
        }
      });
    } else {
      res.statusCode = 405;
      res.end(JSON.stringify({
        "code": 405,
        "message": "Method Not Allowed"
      }));
    }
  } else if (pathName === "/songList") {
    if (method === "GET") {
      // GET è¯·æ±‚ä¸€èˆ¬æ²¡æœ‰è¯·æ±‚ä½“ï¼Œä¼ ç»™æœåŠ¡å™¨çš„ä¸€å †å…¥å‚ä¸€èˆ¬ç›´æ¥æ”¾åœ¨ URL é‡Œ
      const qsString = urlObj.query;
      const qsObj = qsModule.parse(qsString);
      console.log("è¯·æ±‚å‚æ•°ï¼š", qsObj);

      res.end(JSON.stringify({
        "code": 200,
        "message": "è·å–æ­Œå•æˆåŠŸ",
        "data": {
          "id": qsObj.id,
          "page": qsObj.page,
          "size": qsObj.size,
        },
      }));
    } else {
      res.statusCode = 405;
      res.end(JSON.stringify({
        "code": 405,
        "message": "Method Not Allowed"
      }));
    }
  } else {
    res.statusCode = 404;
    res.end(JSON.stringify({
      "code": 404,
      "message": "Not Found"
    }));
  }
});

// ç¬¬äº”æ­¥ï¼šæ‰‹åŠ¨è¿è¡Œ http æœåŠ¡å™¨æµ‹è¯•çœ‹çœ‹æ•ˆæœï¼ˆå®é™…éƒ¨ç½²çš„è¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ‰‹åŠ¨è¿è¡Œï¼Œè€Œæ˜¯äº¤ç»™æœåŠ¡å™¨è‡ªåŠ¨è¿è¡Œï¼Œéƒ¨ç½²æµç¨‹åé¢ä¸“é—¨è¯´ï¼‰
// cd åˆ°å½“å‰æ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œâ€œnode 01_åŸºæœ¬ä½¿ç”¨.jsâ€å‘½ä»¤ï¼ŒæœåŠ¡å™¨å°±è¿è¡Œèµ·æ¥äº†
// æ‰“å¼€ Postmanï¼Œè®¿é—® http://localhost:8000 æˆ– http://127.0.0.1:8000ï¼ˆå› ä¸ºæ‰‹åŠ¨è¿è¡Œæ—¶æœåŠ¡å™¨æ˜¯è·‘åœ¨æœ¬åœ°çš„ï¼Œæ‰€ä»¥è®¿é—®æ—¶æ˜¯é€šè¿‡ localhost æˆ– 127.0.0.1 æ¥è®¿é—®ï¼‰å°±å¯ä»¥äº†
// æ³¨æ„ï¼šé€šè¿‡ node æ¥æ‰‹åŠ¨è¿è¡Œï¼Œæ¯æ¬¡ä¿®æ”¹äº†æœåŠ¡å™¨çš„ä»£ç åï¼Œéƒ½éœ€è¦é‡æ–°è¿è¡ŒæœåŠ¡å™¨ï¼Œå¦åˆ™æœåŠ¡å™¨ä¸ä¼šè‡ªåŠ¨æ›´æ–°
// 
// æ‰€ä»¥ä¸ºäº†è®©æœåŠ¡å™¨èƒ½åœ¨ä¿®æ”¹ä»£ç åè‡ªåŠ¨æ›´æ–°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ nodemon å·¥å…·æ¥è¿è¡ŒæœåŠ¡å™¨
// é¦–å…ˆæ‰§è¡Œå‘½ä»¤å…¨å±€å®‰è£… nodemonï¼šnpm install nodemon -g
// ç„¶åä½¿ç”¨ nodemon è¿è¡ŒæœåŠ¡å™¨ï¼šcd åˆ°å½“å‰æ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œâ€œnodemon 01_åŸºæœ¬ä½¿ç”¨.jsâ€å‘½ä»¤ï¼ŒæœåŠ¡å™¨å°±è¿è¡Œèµ·æ¥äº†
